// The component for displaying the details of a selected vulnerability.
'use client';

import type { Vulnerability } from '@/lib/types';
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from '@/components/ui/sheet';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Separator } from '@/components/ui/separator';
import { Badge } from '@/components/ui/badge';
import React from 'react';

function SimpleCodeRenderer({ text }: { text: string }) {
    const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
    let lastIndex = 0;
    const result: React.ReactNode[] = [];
  
    let match;
    while ((match = codeBlockRegex.exec(text)) !== null) {
      if (match.index > lastIndex) {
        result.push(<p key={`text-${lastIndex}`} className="whitespace-pre-wrap">{text.substring(lastIndex, match.index)}</p>);
      }
      const code = match[2];
      result.push(
        <div key={`code-${lastIndex}`} className="my-4 rounded-md bg-muted text-muted-foreground border">
          <pre className="p-4 text-sm overflow-x-auto"><code className="font-code">{code}</code></pre>
        </div>
      );
      lastIndex = match.index + match[0].length;
    }
  
    if (lastIndex < text.length) {
      result.push(<p key={`text-${lastIndex}`} className="whitespace-pre-wrap">{text.substring(lastIndex)}</p>);
    }
  
    return <>{result.length > 0 ? result : <p className="whitespace-pre-wrap">{text}</p>}</>;
}


export function VulnerabilityDetails({
    vulnerability,
    onOpenChange
}: {
    vulnerability: Vulnerability | null;
    onOpenChange: (open: boolean) => void;
}) {
    const severityBadgeVariants = {
        High: 'destructive',
        Medium: 'secondary',
        Low: 'outline',
    } as const;

    if (!vulnerability) {
        return null;
    }

    return (
        <Sheet open={!!vulnerability} onOpenChange={onOpenChange}>
            <SheetContent className="w-full sm:max-w-2xl p-0">
                <ScrollArea className="h-full">
                  <div className="p-6">
                    <SheetHeader className="text-left mb-6">
                        <SheetTitle className="text-2xl">{vulnerability.type}</SheetTitle>
                        <SheetDescription>
                            <Badge variant={severityBadgeVariants[vulnerability.severity]} className="capitalize">
                                {vulnerability.severity} Severity
                            </Badge>
                        </SheetDescription>
                    </SheetHeader>
                    
                    <div className="space-y-6">
                        <div>
                            <h3 className="font-semibold text-lg mb-2">Description</h3>
                            <p className="text-muted-foreground whitespace-pre-wrap">{vulnerability.description}</p>
                        </div>
                        <Separator />
                        <div>
                            <h3 className="font-semibold text-lg mb-2">Potential Impact</h3>
                            <p className="text-muted-foreground whitespace-pre-wrap">{vulnerability.potentialImpact}</p>
                        </div>
                        <Separator />
                        <div>
                            <h3 className="font-semibold text-lg mb-2">Remediation</h3>
                            <div className="text-muted-foreground text-sm">
                                <SimpleCodeRenderer text={vulnerability.remediation} />
                            </div>
                        </div>
                    </div>
                  </div>
                </ScrollArea>
            </SheetContent>
        </Sheet>
    );
}
